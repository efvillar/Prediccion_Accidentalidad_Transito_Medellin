---
title: "PREDICCION ACCIDENTES MEDELLIN"
author: "Edwin Villarraga"
date: "16/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# DESCRIPCION DEL PROBLEMA


# HIPOTESIS


# CARGA Y DEPURACION DE DATOS

## Carga de Datos

### Datos de 2014

Durante la carga de datos se realizo la verificacion de las clases de accidentes e inicialmente se identificaron 6 categorias:
1. Atropello
2. Caida_Ocupante
3. Choque
4. Incendio
5. Otro
6. Volcamiento

Sin embargo entre 2014 y 2017 solo se presentaron 17 casos de incendio y en el a単o 2018, 7 casos.  Dada la poca cantidad de eventos se dejaron finalmente 5 categorias dado que incendio se incorporo a otro:

1. Atropello
2. Caida_Ocupante
3. Choque
4. Otro
5. Volcamiento


```{r}
raw_data_2014 <- read.csv(file="./data/Accidentalidad_georreferenciada_2014.csv", encoding="UTF-8", header=TRUE, sep=",")
```


```{r}
head(raw_data_2014)
```

```{r}
summary(raw_data_2014)
```

```{r}
str(raw_data_2014)
```


```{r}
levels(raw_data_2014$CLASE)
```

```{r}
levels(raw_data_2014$CLASE) <- c("Atropello","Caida_Ocupante","Choque","Otro","Otro",
                                 "Volcamiento")
```

```{r}
levels(raw_data_2014$CLASE)
```

### Datos de 2015

```{r}
raw_data_2015 <- read.csv(file="./data/Accidentalidad_georreferenciada_2015.csv", encoding="UTF-8", header=TRUE, sep=",")
```


```{r}
head(raw_data_2015)
```

```{r}
summary(raw_data_2015)
```

```{r}
str(raw_data_2015)
```

```{r}
levels(raw_data_2015$CLASE)
```

```{r}
levels(raw_data_2015$CLASE) <- c("Otro","Atropello","Caida_Ocupante","Caida_Ocupante","Choque",
                                 "Otro","Otro","Volcamiento")
```

```{r}
levels(raw_data_2015$CLASE)
```

### Datos 2016

```{r}
raw_data_2016 <- read.csv(file="./data/Accidentalidad_georreferenciada_2016.csv", encoding="UTF-8", header=TRUE, sep=",")
```


```{r}
head(raw_data_2016)
str(raw_data_2016)
```


```{r}
levels(raw_data_2016$CLASE)
```

```{r}
levels(raw_data_2016$CLASE) <- c("Otro","Atropello","Caida_Ocupante","Caida_Ocupante","Choque",
                                 "Otro","Otro","Volcamiento")
```

```{r}
levels(raw_data_2016$CLASE)
```


### Datos 2017

```{r}
raw_data_2017 <- read.csv(file="./data/Accidentalidad_georreferenciada_2017.csv", encoding="UTF-8", header=TRUE, sep=",")
```


```{r}
head(raw_data_2017)
str(raw_data_2017)
```


```{r}
levels(raw_data_2017$CLASE)
```

```{r}
levels(raw_data_2017$CLASE) <- c("Atropello","Caida_Ocupante","Caida_Ocupante","Choque","Choque",
                                 "Choque","Otro","Otro","Volcamiento")
```

```{r}
levels(raw_data_2017$CLASE)
```


```{r}
summary(raw_data_2014$CLASE)
```

```{r}
summary(raw_data_2015$CLASE)
```

```{r}
summary(raw_data_2016$CLASE)
```

```{r}
summary(raw_data_2017$CLASE)
```


```{r}
raw_data_2018 <- read.csv(file="./data/Accidentalidad_georreferenciada_2018.csv", encoding="UTF-8", header=TRUE, sep=",")
```

```{r}
str(raw_data_2018)
```

```{r}
levels(raw_data_2018$CLASE)
```

```{r}
levels(raw_data_2018$CLASE) <- c("Atropello","Caida_Ocupante","Caida_Ocupante","Choque","Otro","Otro", "Volcamiento")
```

```{r}
levels(raw_data_2018$CLASE)
```


```{r}
summary(raw_data_2018$CLASE)
```


### Union de los datos

```{r}
Total_Dataset <- rbind(raw_data_2014,raw_data_2015,raw_data_2016, raw_data_2017, raw_data_2018)
```

```{r}
str(Total_Dataset)
```

```{r}
levels(Total_Dataset$CLASE)
```

```{r}
summary(Total_Dataset$CLASE)
```

Para ahorra memoria se eliminan los dataframes por a単o

```{r}
rm(raw_data_2014,raw_data_2015,raw_data_2016, raw_data_2017, raw_data_2018)
```


La Fecha esta cargada como factor, se realiza una transformacion a formato de fecha (date)


```{r}
Total_Dataset$FECHA <- as.Date(Total_Dataset$FECHA, format="%Y-%m-%d")
tail(Total_Dataset)
```

Se convierten las variables dia y mes a factor

```{r}
Total_Dataset$DIA <- as.factor(Total_Dataset$DIA)
Total_Dataset$MES <- as.factor(Total_Dataset$MES)
```


```{r}
tail(Total_Dataset)
```

Se genera frecuencia que es la tabla a analizar

```{r}
library(sqldf)
Total_Dataset_Freq <- sqldf("SELECT FECHA, CLASE, count(CLASE) AS FREQ, DIA_NOMBRE, MES, DIA 
       FROM Total_Dataset
       GROUP BY FECHA, CLASE")
```



se agrega la variable a単o al datafrate

```{r}
Total_Dataset_Freq$ANO <- as.factor(format(Total_Dataset_Freq$FECHA,'%Y'))
```

Se agrega la variable semana al dataframe

```{r}
Total_Dataset_Freq$SEMANA <-as.factor(format(Total_Dataset_Freq$FECHA,'%V'))
```


```{r}
tail(Total_Dataset_Freq)
```

Se depura la variable DIA_NOMBRE para eliminar los espacios, quitar tildes, dar un orden al factor

```{r}
levels(Total_Dataset_Freq$DIA_NOMBRE)
```

```{r}
levels(Total_Dataset_Freq$DIA_NOMBRE) <- c("DOMINGO","JUEVES","LUNES","MARTES","MIERCOLES","SABADO","VIERNES") 
```

```{r}
levels(Total_Dataset_Freq$DIA_NOMBRE)
```


```{r}
Total_Dataset_Freq$DIA_NOMBRE <- ordered(Total_Dataset_Freq$DIA_NOMBRE,c("LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO"))
```

```{r}
levels(Total_Dataset_Freq$DIA_NOMBRE)
```

Ahora se agregan otras variables a que caracterizan fechas especiales.  Se carga un CSV y se realiza un left join a la tabla Total_Dataset_Freq


```{r}
Dias_Especiales <- read.csv(file="./data/Caracterizacion.csv", encoding="UTF-8", header=TRUE, sep=";",stringsAsFactors=FALSE)
```

```{r}
head(Dias_Especiales)
```

Se transforma la variable FEcha a formato Fecha pues se cargo como factor y se unifica el nombre a FECHA para que coincida con l clave de la tabla Total_Dataset_Freq

```{r}
Dias_Especiales <- Dias_Especiales[1:1826,]
Dias_Especiales$FECHA <- as.Date(Dias_Especiales$Fecha, format="%d-%m-%Y")
```

```{r}
Dias_Especiales$Fecha <- NULL
```


Estos dias especiales se incorporan al dataframe Total_Dataset_Freq
```{r}
Total_Dataset_Freq <- sqldf("SELECT * 
              FROM Total_Dataset_Freq
              LEFT JOIN Dias_Especiales USING(FECHA)")
```



```{r}
head(Total_Dataset_Freq)
```



# ANALISIS DESCRIPTIVO

## Para el Total de Accidentes

```{r}
library(plotly)
plot_ly(data=Total_Dataset_Freq,
        x = ~FECHA,
        y = ~FREQ,
        type = "scatter", mode = "lines",
        split = ~ANO,
         ine=list(width=1))%>%
  layout(title='Accidentes_Medellin',
         xaxis=list(title="Dia"),
         yaxis=list(title="Unidades"))
```



```{r}
plot_ly(data=Total_Dataset_Freq,
        x = ~ANO,
        y = ~FREQ,
        type = "box")%>%
  layout(title='Accidentes_Medellin',
         xaxis=list(title="ano"),
         yaxis=list(title="Unidades"))
```



```{r}
plot_ly(data=Total_Dataset_Freq,
        x = ~MES,
        y = ~FREQ,
        type = "box")%>%
  layout(title='Accidentes_Medellin',
         xaxis=list(title="Mes"),
         yaxis=list(title="Unidades"))
```


```{r}
plot_ly(data=Total_Dataset_Freq,
        x = ~DIA_NOMBRE,
        y = ~FREQ,
        type = "box")%>%
  layout(title='Accidentes_Medellin',
         xaxis=list(title="Dia_Nombre"),
         yaxis=list(title="Unidades"))
```

Se observa que excepto el domingo que es menor, los demasla accidentalidad promedio es muy similar, pero se diferencia en la cola derecha de la distribucion 


```{r}
plot_ly(data=Total_Dataset_Freq,
        x = ~SEMANA,
        y = ~FREQ,
        type = "box")%>%
  layout(title='Accidentes_Medellin',
         xaxis=list(title="SEMANA"),
         yaxis=list(title="Unidades"))
```



```{r}
attach(Total_Dataset_Freq)
```

```{r}
aggregate(FREQ~ANO*MES, data=Total_Dataset_Freq,FUN=mean)%>%
  plot_ly(x = ~MES,
         y = ~FREQ,
         type = "scatter" ,mode = "lines",
         split = ~ANO,
         line=list(width=1))%>%
  layout(title='Promedio diario mensual de ACCIDENTES en Medellin',
         xaxis=list(title="Mes"),
         yaxis=list(title="No. Accidentes"))
```

```{r}
aggregate(FREQ~ANO*DIA_NOMBRE, data=Total_Dataset_Freq,FUN=mean)%>%
  plot_ly(x = ~DIA_NOMBRE,
         y = ~FREQ,
         type = "scatter" ,mode = "lines",
         split = ~ANO,
         line=list(width=1))%>%
  layout(title='Promedio diario DIA DE LA SEMANA de Accidentes de Transito en Medellin',
         xaxis=list(title="Dia Semana"),
         yaxis=list(title="No. Accidentes"))
```

```{r}
aggregate(FREQ~ANO*CLASE, data=Total_Dataset_Freq,FUN=mean)%>%
  plot_ly(x = ~CLASE,
         y = ~FREQ,
         type = "scatter" ,mode = "lines",
         split = ~ANO,
         line=list(width=1))%>%
  layout(title='Promedio diario CLASE de Accidentes de Transito en Medellin',
         xaxis=list(title="Clase"),
         yaxis=list(title="No. Accidentes"))
```


LAs predicciones a realizar seran para cada uno de las 5 clases de accidentes, y para los periodos de tiempo mensual, semanal y diario, por lo que se generaran 15 modelos, 5 clases de accidente por 3 tipos de periodo de prediccion.

Se realiza entonces la particion de los datos por frecuencia: M: Mensual, S: Semanal, D: Diario

primero se realiza un reshape del dataframe para consolidar los casos por dia y separarlos factores CLASE en columnas



```{r}
library(reshape)
Total_Dataset_Freq <- cast(Total_Dataset_Freq[,c(1,2,3)],FECHA~CLASE)
```

```{r}
Total_Dataset_Freq <- sqldf("SELECT * 
              FROM Total_Dataset_Freq
              LEFT JOIN Dias_Especiales USING(FECHA)")
```


se agrega la variable a単o al datafrate

```{r}
Total_Dataset_Freq$ANO <- as.factor(format(Total_Dataset_Freq$FECHA,'%Y'))
```

Se agrega la variable semana al dataframe

```{r}
Total_Dataset_Freq$SEMANA <-as.factor(format(Total_Dataset_Freq$FECHA,'%V'))
```

SE agrega la variable dia al dataframe

```{r}
Total_Dataset_Freq$DIA <-as.factor(format(Total_Dataset_Freq$FECHA,'%d'))
```

Se agrega el dia de la semana

```{r}
Total_Dataset_Freq$DIA_SEMANA <-as.factor(weekdays(Total_Dataset_Freq$FECHA))
```

Se agrega el mes
```{r}
Total_Dataset_Freq$MES <-as.factor(format(Total_Dataset_Freq$FECHA,'%m'))
```


```{r}
head(Total_Dataset_Freq)
```


Se agrega la columna Total_Accidentes

```{r}
Total_Dataset_Freq$Total_Accidentes <- Total_Dataset_Freq$Atropello + Total_Dataset_Freq$Caida_Ocupante + Total_Dataset_Freq$Choque + Total_Dataset_Freq$Otro + Total_Dataset_Freq$Volcamiento
```

```{r}
tail(Total_Dataset_Freq)
```

```{r}
Total_Dataset_Freq[is.na(Total_Dataset_Freq)] <- 0
```







# EVALUACION DE MODELOS

## 1. Particion de los datos para entrenamiento y test

```{r}
Train_D_Dataset <- subset(Total_Dataset_Freq, ANO!="2018")
```

```{r}
summary(Train_D_Dataset$ANO)
```

Se ajustan otra vez los niveles del factor ANO

```{r}
Train_D_Dataset$ANO <- factor(Train_D_Dataset$ANO)
```

```{r}
summary(Train_D_Dataset$ANO)
```




```{r}
library(sqldf)
Test_D_Dataset <- sqldf("SELECT *  
       FROM Total_Dataset_Freq
       WHERE ANO == 2018")
```

```{r}
summary(Test_D_Dataset$ANO)
```

Se ajustan otra vez los niveles del factor ANO

```{r}
Test_D_Dataset$ANO <- factor(Test_D_Dataset$ANO)
```

```{r}
summary(Test_D_Dataset$ANO)
```

## 2. KNN



```{r}
set.seed(1) # fija la semilla del generador de n炭meros para que sea reproducible
```


```{r}
head(Train_D_Dataset)
```

#DIA_NOMBRE+DIA+SEMANA+MES+ANO+AmoryAmistad+Madre+Padre+Mujer+Prima+Semana.Santa+Feriado

```{r}
library(caret)
```



```{r}
trcntrl = trainControl(method="cv", number=10)
caret_knn_fit = caret::train(Total_Accidentes~DIA+SEMANA+MES+DIA_SEMANA, data=Train_D_Dataset,
                      method = "knn", trControl = trcntrl,
                      preProcess=c("center", "scale"),
                      tuneLength = 10)
```


```{r}
summary(caret_knn_fit)
```

```{r}
caret_knn_fit
```

Calculo MSE y RMSE para los datos de entrenamiento

```{r}
y_tr_pred<-predict(caret_knn_fit,Train_D_Dataset[,c("DIA","SEMANA","MES","DIA_SEMANA")])
mse_tr<-mean((Train_D_Dataset$Total_Accidentes-y_tr_pred)^2) # calcula el mse de entrenamiento
RMSE_tr = sqrt(mse_tr)
mse_tr
RMSE_tr
```



Calculo MSE y RMSE para los datos de prueba (2018)

```{r}
y_test_pred<-predict(caret_knn_fit,Test_D_Dataset[,c("DIA","SEMANA","MES","DIA_SEMANA")])
mse_test<-mean((Test_D_Dataset$Total_Accidentes-y_test_pred)^2) # calcula el mse de entrenamiento
RMSE_test = sqrt(mse_test)
mse_test
RMSE_test
```



## 2. REGRESION LINEAL


```{r}
head(Train_D_Dataset)
```



```{r}
trcntrl = trainControl(method="cv", number=10)
caret_knn_fit = caret::train(Total_Accidentes~SEMANA+DIA_SEMANA+Semana.Santa+Prima+Feriado, data=Train_D_Dataset,
                      method = "lm", trControl = trcntrl,
                      preProcess=c("center", "scale"),
                      tuneLength = 10)
```


```{r}
summary(caret_knn_fit)
```

```{r}
caret_knn_fit
```

Calculo MSE y RMSE para los datos de entrenamiento

```{r}
y_tr_pred<-predict(caret_knn_fit,Train_D_Dataset[,c("SEMANA","DIA_SEMANA","Semana.Santa","Prima","Feriado")])
mse_tr<-mean((Train_D_Dataset$Total_Accidentes-y_tr_pred)^2) # calcula el mse de entrenamiento
RMSE_tr = sqrt(mse_tr)
mse_tr
RMSE_tr
```

```{r}
y_test_pred<-predict(caret_knn_fit,Test_D_Dataset[,c("SEMANA","DIA_SEMANA","Semana.Santa","Prima","Feriado")])
mse_test<-mean((Test_D_Dataset$Total_Accidentes-y_test_pred)^2) # calcula el mse de entrenamiento
RMSE_test = sqrt(mse_test)
mse_test
RMSE_test
```





## 3. MODELO LINEAL GENERALIZADO



## 4. ARBOLES DE REGRESION



## 5. BOSQUE ALEATORIO


## 6. XGBOOST



## 7. RED NEURONAL


## 8. SERIE DE TIEMPO





# ELECCION DEL MODELO